<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星际密室 - 控制塔</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义样式 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        terminal: '#39FF14',
                        logbook: '#FFD700',
                        scanner: '#1E90FF',
                        dark: '#0F172A',
                        success: '#4CAF50',
                        danger: '#f44336'
                    },
                    fontFamily: {
                        tech: ['Orbitron', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'fade-in': 'fadeIn 0.5s forwards',
                        'pulse-border': 'pulseBorder 1.5s infinite',
                        'glow-border': 'glowBorder 2s ease-in-out infinite alternate',
                        'count-update': 'countUpdate 0.5s ease-out',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        glow: {
                            '0%': { 'box-shadow': '0 0 5px rgba(22, 93, 255, 0.5)' },
                            '100%': { 'box-shadow': '0 0 20px rgba(22, 93, 255, 0.8)' }
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 }
                        },
                        pulseBorder: {
                            '0%, 100%': { 'box-shadow': '0 0 5px 2px rgba(22, 93, 255, 0.7)' },
                            '50%': { 'box-shadow': '0 0 10px 4px rgba(22, 93, 255, 0.9)' }
                        },
                        glowBorder: {
                            '0%': { 'box-shadow': '0 0 5px 1px rgba(255, 255, 255, 0.6)' },
                            '100%': { 'box-shadow': '0 0 15px 3px rgba(255, 255, 255, 0.9)' }
                        },
                        countUpdate: {
                            '0%': { transform: 'scale(1)', color: 'white' },
                            '50%': { transform: 'scale(1.3)', color: '#39FF14' },
                            '100%': { transform: 'scale(1)', color: 'white' }
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 0 8px rgba(22, 93, 255, 0.8);
            }
            .提示框 {
                @apply absolute border-2 border-white/80 text-white px-3 py-1.5 rounded-lg pointer-events-none z-10 transition-all duration-300;
            }
            .交互区域 {
                @apply absolute cursor-pointer transition-all duration-300 z-10;
            }
            .交互区域:hover .提示框 {
                @apply animate-glow-border;
            }
            .已探索 .提示框 {
                @apply animate-glow-border;
            }
            .交互区域:hover {
                @apply scale-105;
            }
            .count-animate {
                @apply animate-count-update;
            }
            .password-digit {
                @apply w-10 h-12 text-center text-2xl font-bold bg-dark/70 border-2 border-primary rounded-md focus:outline-none focus:border-terminal transition-all;
            }
        }
    </style>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-dark min-h-screen font-tech text-white overflow-x-hidden">
    <header class="bg-dark/80 backdrop-blur-md border-b border-primary/30 py-3 px-6 flex justify-between items-center z-30 relative">
        <div class="flex items-center gap-4">
            <button id="返回选择" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-primary/20 hover:bg-primary/40 transition-all">
                <i class="fa fa-arrow-left text-primary"></i>
                <span class="text-sm">返回选择</span>
            </button>
            <div class="flex items-center gap-2">
                <i class="fa fa-shield text-primary text-xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-shadow">星际密室 - 控制塔</h1>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:flex items-center gap-1 text-sm">
                <i class="fa fa-map-marker text-primary"></i>
                <span>主控制区</span>
            </div>
            <div class="flex items-center gap-1 text-sm">
                <i class="fa fa-compass text-primary"></i>
                <span id="探索计数">已探索: 0/3</span>
            </div>
        </div>
    </header>

    <main class="relative min-h-[calc(100vh-64px)] flex items-center justify-center p-4">
        <div class="absolute inset-0 z-0">
            <img src="control-bg.jpg" 
                 alt="未来科技风格的控制塔内部，中央有终端屏幕，左侧有扫描仪，右侧有日志本" 
                 class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-b from-dark/30 via-dark/20 to-dark/50"></div>
        </div>

        <div class="absolute top-8 left-1/2 -translate-x-1/2 text-center z-20 animate-fade-in">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-2 text-shadow">主控制塔</h2>
            <p class="text-gray-300 max-w-2xl mx-auto">探索全部3个区域，获取密码后组合成9位数字解锁出口</p>
        </div>

        <div class="relative w-full max-w-6xl mx-auto aspect-[16/9] z-10">
            <!-- 主控终端区域 -->
            <div id="terminal-区域" class="交互区域" data-type="terminal" style="width: 55%; height: 40%; top: 37%; left: 28%;">
                <div class="提示框 text-center left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                    <i class="fa fa-terminal mr-1"></i>主控终端
                </div>
            </div>

            <!-- 实验日志区域 -->
            <div id="logbook-区域" class="交互区域" data-type="logbook" style="width: 22%; height: 28%; top: 35%; right: 5%;">
                <div class="提示框 text-center left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                    <i class="fa fa-book mr-1"></i>实验日志
                </div>
            </div>

            <!-- 能量扫描仪区域 -->
            <div id="scanner-区域" class="交互区域" data-type="scanner" style="width: 25%; height: 40%; top: 51%; left: 5%;">
                <div class="提示框 text-center left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                    <i class="fa fa-rss mr-1"></i>能量扫描仪
                </div>
            </div>
        </div>

        <!-- 密码输入区域（初始隐藏，全探索后显示） -->
        <div id="密码输入区" class="absolute bottom-12 left-1/2 -translate-x-1/2 text-center opacity-0 transition-all duration-1000 scale-95 z-20" style="display: none; max-width: 600px; width: 90%;">
            <div class="bg-primary/20 backdrop-blur-sm rounded-xl p-6 border-2 border-primary animate-glow transition-all duration-300">
                <h3 class="text-2xl font-bold mb-3 text-primary">实验室出口</h3>
                <p class="text-gray-300 mb-4">已探索全部区域！输入9位密码解锁出口</p>
                
                <!-- 新增：密码验证状态显示（之前缺失的元素） -->
                <div id="密码状态" class="h-6 text-center mb-4 text-gray-400">
                   
                </div>
                
                <!-- 密码输入框：分3组，每组3位 -->
                <div class="mb-6 flex justify-center gap-2 md:gap-4 flex-wrap">
                    <!-- 主控终端密码（第1-3位） -->
                    <div class="flex gap-2">
                        <input type="text" maxlength="1" class="password-digit" data-index="0" placeholder="*">
                        <input type="text" maxlength="1" class="password-digit" data-index="1" placeholder="*">
                        <input type="text" maxlength="1" class="password-digit" data-index="2" placeholder="*">
                    </div>
                    
                    <span class="text-xl self-center text-gray-400">-</span>
                    
                    <!-- 实验日志密码（第4-6位） -->
                    <div class="flex gap-2">
                        <input type="text" maxlength="1" class="password-digit" data-index="3" placeholder="*">
                        <input type="text" maxlength="1" class="password-digit" data-index="4" placeholder="*">
                        <input type="text" maxlength="1" class="password-digit" data-index="5" placeholder="*">
                    </div>
                    
                    <span class="text-xl self-center text-gray-400">-</span>
                    
                    <!-- 能量扫描仪密码（第7-9位） -->
                    <div class="flex gap-2">
                        <input type="text" maxlength="1" class="password-digit" data-index="6" placeholder="*">
                        <input type="text" maxlength="1" class="password-digit" data-index="7" placeholder="*">
                        <input type="text" maxlength="1" class="password-digit" data-index="8" placeholder="*">
                    </div>
                </div>
                
                
                <!-- 验证密码按钮 -->
                <button id="验证密码" class="bg-primary hover:bg-primary/80 text-white px-6 py-3 rounded-lg flex items-center gap-2 mx-auto transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span>验证密码</span>
                    <i class="fa fa-key"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- 逃出成功页面（默认隐藏） -->
    <div id="逃出成功页" class="fixed inset-0 bg-dark z-50 flex flex-col items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-1000">
        <div class="text-center max-w-2xl">
            <div class="text-success text-6xl mb-6 animate-pulse">
                <i class="fa fa-check-circle"></i>
            </div>
            <h2 class="text-4xl font-bold mb-4 text-white">成功逃出实验室！</h2>
            <p class="text-gray-300 mb-8 text-lg">你探索了全部区域，破解了密码，成功逃出实验室！</p>
            <button id="重新开始" class="mt-8 bg-primary hover:bg-primary/80 text-white px-8 py-4 rounded-lg text-lg transition-all">
                重新挑战
            </button>
        </div>
    </div>

    <div id="返回按钮" class="fixed bottom-6 right-6 z-50" style="display: none;">
        <button id="返回控制塔" class="bg-dark/80 backdrop-blur-md hover:bg-primary text-white w-12 h-12 rounded-full flex items-center justify-center border border-primary/50 transition-all shadow-lg">
            <i class="fa fa-home"></i>
        </button>
    </div>

    <!-- ChatSDK加载失败备用按钮 -->
    <div id="chat-retry-btn">
        <i class="fa fa-comment-dots"></i>
    </div>

    <!-- 引入独立的ChatSDK JS文件 -->
    <script src="chat-sdk.js"></script>

    <!-- 游戏逻辑（修复密码验证和成功页显示） -->
    <script>
        // 游戏状态初始化：记录已探索区域和密码
        let gameState;
        try {
            const savedState = localStorage.getItem('mishiGameState');
            if (savedState) {
                gameState = JSON.parse(savedState);
                // 确保数据结构完整
                gameState.exploredAreas = gameState.exploredAreas || {
                    terminal: false,
                    logbook: false,
                    scanner: false
                };
                gameState.passwords = gameState.passwords || {
                    terminal: null,
                    logbook: null,
                    scanner: null
                };
            } else {
                // 新游戏：初始所有区域未探索，密码为空
                gameState = {
                    exploredAreas: {
                        terminal: false,
                        logbook: false,
                        scanner: false
                    },
                    passwords: {
                        terminal: null,
                        logbook: null,
                        scanner: null
                    },
                    currentScene: 'control-tower'
                };
            }
        } catch (e) {
            console.error('读取游戏状态失败，重置为初始状态:', e);
            gameState = {
                exploredAreas: {
                    terminal: false,
                    logbook: false,
                    scanner: false
                },
                passwords: {
                    terminal: null,
                    logbook: null,
                    scanner: null
                },
                currentScene: 'control-tower'
            };
        }

        // 保存游戏状态到本地存储
        function saveGameState() {
            localStorage.setItem('mishiGameState', JSON.stringify(gameState));
        }

        // 关卡页面映射
        const taskPages = {
            terminal: 'mokuai.html',   // 主控终端关卡页
            logbook: 'puzzle.html',    // 实验日志关卡页
            scanner: 'saomiao.html'    // 能量扫描仪关卡页
        };

        // DOM元素获取（确保所有元素都能找到）
        const 探索计数 = document.getElementById('探索计数');
        const 交互区域列表 = document.querySelectorAll('.交互区域');
        const 密码输入区 = document.getElementById('密码输入区');
        const 返回选择 = document.getElementById('返回选择');
        const 密码输入框 = document.querySelectorAll('.password-digit');
        const 验证密码按钮 = document.getElementById('验证密码');
        const 密码状态 = document.getElementById('密码状态'); // 现在HTML里有这个元素了
        const 逃出成功页 = document.getElementById('逃出成功页');
        const 重新开始按钮 = document.getElementById('重新开始');

        // 更新探索计数并控制密码输入区显示
        function updateExploreCount() {
            const exploredCount = Object.values(gameState.exploredAreas).filter(area => area).length;
            探索计数.classList.remove('count-animate');
            void 探索计数.offsetWidth; // 强制重绘以触发动画
            探索计数.textContent = `已探索: ${exploredCount}/3`;
            探索计数.classList.add('count-animate');

            // 全部探索后显示密码输入区
            if (exploredCount === 3) {
                showPasswordInputArea();
            }
        }

        // 显示密码输入区（淡入动画）
        function showPasswordInputArea() {
            密码输入区.style.display = 'block';
            setTimeout(() => {
                密码输入区.classList.add('opacity-100', 'scale-100');
                密码输入区.classList.remove('opacity-0', 'scale-95');
            }, 100);
            // 自动填充已保存的密码（如果有）
            fillPasswords();
        }

        // 填充已保存的密码（从各关卡返回后）
        function fillPasswords() {
            // 主控终端密码（第1-3位）
            if (gameState.passwords.terminal) {
                const terminalPwd = gameState.passwords.terminal.toString().padStart(3, '0');
                密码输入框[0].value = terminalPwd[0];
                密码输入框[1].value = terminalPwd[1];
                密码输入框[2].value = terminalPwd[2];
            }
            // 实验日志密码（第4-6位）
            if (gameState.passwords.logbook) {
                const logbookPwd = gameState.passwords.logbook.toString().padStart(3, '0');
                密码输入框[3].value = logbookPwd[0];
                密码输入框[4].value = logbookPwd[1];
                密码输入框[5].value = logbookPwd[2];
            }
            // 能量扫描仪密码（第7-9位）
            if (gameState.passwords.scanner) {
                const scannerPwd = gameState.passwords.scanner.toString().padStart(3, '0');
                密码输入框[6].value = scannerPwd[0];
                密码输入框[7].value = scannerPwd[1];
                密码输入框[8].value = scannerPwd[2];
            }
            // 检查密码是否完整，启用验证按钮
            checkPasswordComplete();
        }

        // 标记区域为“已探索”
        function markAreaAsExplored(areaType) {
            if (!['terminal', 'logbook', 'scanner'].includes(areaType)) {
                console.error('无效的区域类型:', areaType);
                return;
            }
            if (!gameState.exploredAreas[areaType]) {
                gameState.exploredAreas[areaType] = true;
                const 区域 = document.querySelector(`[data-type="${areaType}"]`);
                if (区域) {
                    区域.classList.add('已探索');
                }
                updateExploreCount();
                saveGameState();
            }
        }

        // 跳转到对应关卡页面
        function goToTaskPage(areaType) {
            if (!taskPages[areaType]) {
                console.error('无效的关卡页面:', areaType);
                alert('页面不存在');
                return;
            }
            markAreaAsExplored(areaType);
            saveGameState();
            setTimeout(() => {
                window.location.href = taskPages[areaType];
            }, 300);
        }

        // 检查密码是否完整（9位数字）
        function checkPasswordComplete() {
            let isComplete = true;
            密码输入框.forEach(input => {
                // 只允许数字，过滤非数字字符
                input.value = input.value.replace(/[^0-9]/g, '');
                if (!input.value || input.value.length !== 1) {
                    isComplete = false;
                }
            });
            验证密码按钮.disabled = !isComplete;
        }

        // 验证密码（正确密码：190536322）- 修复成功页显示逻辑
        function verifyPassword() {
            let userInput = '';
            密码输入框.forEach(input => {
                userInput += input.value;
            });
            const correctPassword = '190536322';
            
            if (userInput === correctPassword) {
                // 密码正确：显示成功提示 + 跳成功页
                密码状态.textContent = '密码正确！正在解锁出口...';
                密码状态.className = 'h-6 text-center mb-4 text-success font-medium';
                
                // 禁用输入和按钮，防止重复点击
                验证密码按钮.disabled = true;
                密码输入框.forEach(input => input.disabled = true);
                
                // 延迟显示成功页（模拟“解锁中”的过程）
                setTimeout(() => {
                    逃出成功页.classList.remove('opacity-0', 'pointer-events-none');
                }, 1200);
            } else {
                // 密码错误：显示错误提示 + 输入框抖动
                密码状态.textContent = '密码错误，请重新输入！';
                密码状态.className = 'h-6 text-center mb-4 text-danger font-medium';
                密码输入区.classList.add('animate-shake');
                setTimeout(() => {
                    密码输入区.classList.remove('animate-shake');
                }, 500);
            }
        }

        // 返回选择页面
        function goToXuanzePage() {
            saveGameState();
            window.location.href = 'xuanze.html';
        }

        // 重新开始游戏
        function restartGame() {
            localStorage.removeItem('mishiGameState');
            window.location.href = 'xuanze.html';
        }

        // 绑定事件
        function bindEvents() {
            // 交互区域点击事件
            交互区域列表.forEach(区域 => {
                区域.addEventListener('click', () => {
                    const areaType = 区域.getAttribute('data-type');
                    if (areaType) {
                        goToTaskPage(areaType);
                    } else {
                        console.error('交互区域缺少data-type属性');
                    }
                });
            });

            // 密码输入框事件
            密码输入框.forEach(input => {
                input.addEventListener('input', () => {
                    checkPasswordComplete();
                    // 自动跳转到下一个输入框
                    const currentIndex = parseInt(input.dataset.index);
                    if (input.value && currentIndex < 8) {
                        const nextInput = document.querySelector(`[data-index="${currentIndex + 1}"]`);
                        nextInput?.focus();
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value) {
                        const currentIndex = parseInt(input.dataset.index);
                        if (currentIndex > 0) {
                            const prevInput = document.querySelector(`[data-index="${currentIndex - 1}"]`);
                            prevInput?.focus();
                        }
                    }
                });
            });

            // 验证密码按钮（现在能正常触发了）
            验证密码按钮.addEventListener('click', verifyPassword);

            // 返回选择页面
            返回选择.addEventListener('click', goToXuanzePage);

            // 重新开始游戏
            重新开始按钮.addEventListener('click', restartGame);
        }

        // 初始化已探索区域的视觉状态
        function initExploredAreas() {
            Object.keys(gameState.exploredAreas).forEach(areaType => {
                if (gameState.exploredAreas[areaType]) {
                    const 区域 = document.querySelector(`[data-type="${areaType}"]`);
                    if (区域) {
                        区域.classList.add('已探索');
                    }
                }
            });
            updateExploreCount();
        }

        // 初始化页面
        function initPage() {
            initExploredAreas();
            bindEvents();
        }

        // 初始化游戏页面
        initPage();

        // 初始化ChatSDK
        try {
            const chatSDK = new FloatingChatSDK({
                appId: "7551596535822958646",
                workflowId: "7560369410436513828",
                token: "sat_ZUvu7vrte22QySxTNgbO2PXp1xo5jJGOF8CaxtclU6NqxKBYZirfGVxdU6ir0Nik",
                primaryColor: "#165DFF", // 匹配页面主色
                retryBtn: document.getElementById('chat-retry-btn')
            });
            if (chatSDK.hideRetryBtn) chatSDK.hideRetryBtn();
        } catch (e) {
            console.error('ChatSDK加载失败:', e);
            document.getElementById('chat-retry-btn').style.display = 'flex';
        }
    </script>
</body>
</html>