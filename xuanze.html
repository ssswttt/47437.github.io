<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数谜探索局 - 数学思维挑战</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primaryBg: '#F3E8FF',
                        secondaryAccent: '#1E293B',
                        primary: '#7B61FF', // 默认主色（会被ChatSDK动态覆盖）
                        secondary: '#4F46E5',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    borderRadius: {
                        'tech': '12px',
                    },
                    boxShadow: {
                        'card': '0 4px 16px rgba(123, 97, 255, 0.1)', // 会被动态覆盖
                        'cardHover': '0 6px 24px rgba(123, 97, 255, 0.15)', // 会被动态覆盖
                        'modal': '0 10px 30px rgba(0, 0, 0, 0.15)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .text-gradient { 
                background-clip: text; 
                -webkit-background-clip: text; 
                color: transparent; 
                background-image: linear-gradient(90deg, #7B61FF, #4F46E5); /* 会被动态覆盖 */
            }
            .card-transition { transition: all 0.3s ease; }
            .btn-gradient { background: linear-gradient(90deg, #7B61FF, #4F46E5); } /* 会被动态覆盖 */
            .modal-overlay { background-color: rgba(0, 0, 0, 0.3); }
        }
    </style>
    <style>
        /* 1. 重置全局样式，防止SDK污染 */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: #f9f4fe;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            overflow-x: hidden !important;
        }

        /* 2. 固定页面主容器宽度 */
        .container {
            max-width: 1280px !important;
            width: 100% !important;
            margin-left: auto !important;
            margin-right: auto !important;
            padding-left: 1rem !important;
            padding-right: 1rem !important;
            box-sizing: border-box !important;
        }

        /* 原有样式保留（颜色会被ChatSDK动态覆盖） */
        .explore-card:hover { transform: translateY(-4px); box-shadow: var(--tw-shadow-cardHover); }
        .input-focus { transition: all 0.2s ease; }
        .stream-text { white-space: pre-line; animation: typing 0.08s steps(2) infinite; }
        @keyframes typing { 0%, 100% { opacity: 0.9; } 50% { opacity: 1; } }
        #recommendation-result { word-break: break-all; line-height: 1.6; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }

        /* 3. 聊天组件基础定位（颜色由ChatSDK控制） */
        .coze-asst-btn {
            right: 20px !important;
            bottom: 20px !important;
            visibility: visible !important;
            z-index: 99999 !important;
            opacity: 1 !important;
            position: fixed !important;
            width: 56px !important;
            height: 56px !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .coze-asst-btn .btn {
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important;
            border: none !important;
            padding: 0 !important;
        }
        .coze-chat-container {
            width: 380px !important;
            border-radius: 12px !important;
            z-index: 99998 !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1) !important;
            position: fixed !important;
            bottom: 86px !important;
            right: 20px !important;
            margin: 0 !important;
            padding: 0 !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }
        .coze-chat-header {
            color: white !important;
            padding: 0.5rem 1rem !important;
            margin: 0 !important;
        }

        /* 4. 聊天重试按钮基础样式 */
        #chat-retry-btn {
            position: fixed !important;
            right: 20px !important;
            bottom: 20px !important;
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important;
            color: white !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            z-index: 99999 !important;
            font-size: 20px !important;
            display: none !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
    </style>
</head>
<body class="primaryBg font-inter">
    <!-- 提示弹窗（提示圈颜色由ChatSDK控制） -->
    <div id="tip-modal" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay modal-hidden">
        <div class="bg-white rounded-tech shadow-modal w-full max-w-md p-6 transform transition-all">
            <div class="flex items-start">
                <!-- 【修改1/2】给图标添加 chat-sdk-icon 类（仅用于ChatSDK控制颜色） -->
                <div class="flex-shrink-0 text-primary">
                    <i class="fas fa-exclamation-circle text-xl chat-sdk-icon"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-gray-900">提示</h3>
                    <div class="mt-2 text-sm text-gray-700">
                        请先输入数学知识点，以便获取更精准的探索路径～
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="modal-close" class="btn-gradient hover:opacity-90 text-white font-medium px-4 py-2 rounded-tech transition-all text-sm">
                            知道了
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主容器：样式不变 -->
    <div class="container mx-auto px-4 py-6 max-w-6xl" style="width: 100%; max-width: 1280px; margin: 0 auto; padding: 1.5rem 1rem; box-sizing: border-box;">
        <!-- 返回首页和标题区域 -->
        <div class="flex justify-between items-center mb-4">
            <a href="home.html" class="inline-flex items-center text-primary hover:text-secondary transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                <span class="font-medium">返回首页</span>
            </a>
            
            <div class="text-center flex-1 mx-4">
                <h1 class="text-2xl md:text-3xl font-bold mb-2 text-gradient">数谜探索局</h1>
                <p class="text-gray-600 max-w-xl mx-auto text-sm md:text-base">选择适合您的数学挑战模式，开启思维探险之旅</p>
            </div>
            
            <div class="w-32"></div>
        </div>

        <div class="bg-white rounded-tech shadow-card p-4 mb-6" style="width: 100%; box-sizing: border-box;">
            <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-lightbulb text-primary mr-2"></i> <!-- 提示圈：颜色同步主色 -->
                为您推荐的探索路径
            </h2>
            <div id="recommendation-result" class="min-h-28 flex items-center justify-center p-3 bg-gray-50 rounded" style="width: 100%; box-sizing: border-box;">
                <p class="text-gray-500 text-center text-sm">页面加载中，AI 正在生成推荐...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" style="width: 100%; box-sizing: border-box;">
            <div class="bg-white rounded-tech shadow-card overflow-hidden explore-card card-transition" style="width: 100%; box-sizing: border-box;">
                <div class="h-40">
                    <img src="juben.png" alt="数探谜案" class="w-full h-full object-cover">
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">数探谜案</h3>
                    <p class="text-gray-600 mb-4 text-sm">化身剧本杀侦探，在故事化线索与谜题卡中，挖掘数学规律，体验逻辑推理的沉浸感。</p>
                    <a 
                        href="qingjing.html" 
                        class="explore-link inline-block btn-gradient hover:opacity-90 text-white font-medium py-2 px-4 rounded-tech transition-all text-sm" 
                        data-mode="数探谜案"
                    >
                        进入数探谜案
                    </a>
                </div>
            </div>

            <div class="bg-white rounded-tech shadow-card overflow-hidden explore-card card-transition" style="width: 100%; box-sizing: border-box;">
                <div class="h-40">
                    <img src="mishi.png" alt="数谜之境" class="w-full h-full object-cover">
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">数谜之境</h3>
                    <p class="text-gray-600 mb-4 text-sm">进入密室逃脱式数字空间，破解机关、解码数学线索，在闯关过程中掌握知识与逻辑。</p>
                    <a 
                        href="mishi.html" 
                        class="explore-link inline-block btn-gradient hover:opacity-90 text-white font-medium py-2 px-4 rounded-tech transition-all text-sm" 
                        data-mode="数谜之境"
                    >
                        进入数谜之境
                    </a>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-tech shadow-card p-4" style="width: 100%; box-sizing: border-box;">
            <h2 class="text-lg font-bold text-gray-800 mb-3">探索特定数学知识点</h2>
            <div class="flex flex-col sm:flex-row gap-3" style="width: 100%; box-sizing: border-box;">
                <input type="text" id="knowledge-input" placeholder="例如：二次函数、几何证明、概率统计..." 
                    class="flex-grow border border-gray-300 rounded-lg px-3 py-2 input-focus text-gray-700 font-medium text-sm"
                    style="box-sizing: border-box;">
                <button id="confirm-btn" class="btn-gradient hover:opacity-90 text-white font-medium px-4 py-2 rounded-tech transition-all text-sm">
                    <i class="fas fa-check mr-1"></i>确认提交
                </button>
            </div>
        </div>
    </div>

    <!-- 聊天加载失败备用按钮 -->
    <div id="chat-retry-btn">
        <i class="fas fa-comment-dots"></i>
    </div>

    <!-- 关键：引入独立的ChatSDK JS文件 -->
    <script src="chat-sdk.js"></script>

    <!-- 原有推荐逻辑（完全保留，未修改） -->
    <script>
        const knowledgeInput = document.getElementById('knowledge-input');
        const confirmBtn = document.getElementById('confirm-btn');
        const recommendationResult = document.getElementById('recommendation-result');
        const exploreLinks = document.querySelectorAll('.explore-link');
        const tipModal = document.getElementById('tip-modal');
        const modalClose = document.getElementById('modal-close');
        let hasInputKnowledge = false;
        console.log('[初始化] 页面元素加载完成，初始状态：hasInputKnowledge =', hasInputKnowledge);

        function showModal() {
            tipModal.classList.remove('modal-hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideModal() {
            tipModal.classList.add('modal-hidden');
            document.body.style.overflow = '';
        }

        async function streamCozeRecommendation(knowledge = '') {
            console.log('[API请求-发起] 开始调用 Coze 流式API，知识点：', knowledge);
            recommendationResult.innerHTML = `
                <div class="animate-pulse flex flex-col items-center justify-center space-y-3 py-6 w-full">
                    <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full"></div>
                    <p class="text-gray-500 text-sm">AI 正在生成推荐...</p>
                </div>
            `;

            try {
                const requestBody = {
                    workflow_id: '7559559271718764590',
                    app_id: '7559518904885116991',
                    parameters: { knowledge: knowledge }
                };

                const response = await fetch('https://api.coze.cn/v1/workflow/stream_run', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer sat_ZUvu7vrte22QySxTNgbO2PXp1xo5jJGOF8CaxtclU6NqxKBYZirfGVxdU6ir0Nik',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                console.log('[API请求-响应] 收到API响应，状态码：', response.status, '，响应状态：', response.ok);

                if (!response.ok) throw new Error(`API 请求失败，状态码：${response.status}，状态文本：${response.statusText}`);
                if (!response.body) throw new Error('流式响应体不可用，无法获取SSE数据');

                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let accumulatedOutput = '';
                console.log('[SSE处理-初始化] 开始监听SSE流，准备解析双层JSON嵌套结构');

                recommendationResult.innerHTML = `
                    <div class="text-left p-3 stream-text text-gray-700 text-sm w-full" id="stream-output"></div>
                `;
                const streamOutput = document.getElementById('stream-output');

                while (true) {
                    const { done, value } = await reader.read();
                    console.log('[SSE处理-读取] 读取流片段，done状态：', done, '，片段字节长度：', value ? value.length : 0);

                    if (done) {
                        console.log('[SSE处理-结束] SSE流已关闭，累计输出内容长度：', accumulatedOutput.length);
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    console.log('[SSE处理-解码] 解码后文本片段：', chunk.slice(0, 300) + (chunk.length > 300 ? '...' : ''));

                    const sseMessages = chunk.split('\n\n').filter(msg => msg.trim());
                    console.log('[SSE处理-分割] 分割出有效SSE消息数量：', sseMessages.length);

                    sseMessages.forEach((msg, index) => {
                        console.log(`[SSE处理-解析] 开始解析第 ${index + 1} 条SSE消息`);
                        
                        const dataLines = msg.split('\n').filter(line => line.startsWith('data:'));
                        if (dataLines.length === 0) {
                            console.log(`[SSE处理-过滤] 第 ${index + 1} 条消息无data字段，跳过`);
                            return;
                        }

                        const fullDataStr = dataLines.map(line => line.slice(5).trim()).join('');
                        console.log(`[SSE处理-解析] 第 ${index + 1} 条消息的data字符串：`, fullDataStr.slice(0, 200) + (fullDataStr.length > 200 ? '...' : ''));

                        try {
                            const firstLayerData = JSON.parse(fullDataStr);
                            console.log(`[SSE处理-解析] 第一层JSON键：`, Object.keys(firstLayerData));

                            if (!firstLayerData.content) {
                                console.log(`[SSE处理-警告] 无content字段，跳过`);
                                return;
                            }

                            const secondLayerData = JSON.parse(firstLayerData.content);
                            console.log(`[SSE处理-解析] 第二层JSON键：`, Object.keys(secondLayerData));

                            const currentOutput = secondLayerData.output || '';
                            if (currentOutput) {
                                accumulatedOutput += currentOutput;
                                streamOutput.textContent = accumulatedOutput;
                                console.log(`[SSE处理-更新] 累计output长度：`, accumulatedOutput.length);
                            }
                        } catch (e) {
                            console.error(`[SSE处理-错误] 第 ${index + 1} 条消息解析失败：`, e.message);
                        }
                    });
                }

                if (!accumulatedOutput.trim()) {
                    streamOutput.innerHTML = '<p class="text-gray-500 text-center">未获取到有效推荐内容，请稍后重试</p>';
                } else {
                    console.log('[SSE处理-结果] 推荐内容生成完成');
                }

            } catch (error) {
                const errorMsg = `获取推荐失败：${error.message}`;
                recommendationResult.innerHTML = `<div class="text-center p-4 text-red-500 text-sm w-full">${errorMsg}</div>`;
                console.error('[API请求-错误] 详情：', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('[页面生命周期] DOMContentLoaded 触发，初始化推荐');
            streamCozeRecommendation();

            // 【修改2/2】初始化ChatSDK，指定颜色（仅影响聊天组件和带chat-sdk-icon类的元素）
            new FloatingChatSDK({
                appId: "7551596535822958646",
                workflowId: "7560369410436513828",
                token: "sat_ZUvu7vrte22QySxTNgbO2PXp1xo5jJGOF8CaxtclU6NqxKBYZirfGVxdU6ir0Nik",
                primaryColor: "#7B61FF" // 恢复原页面默认紫色，避免变红；其他页面可改（如#4ECDC4绿色、#45B7D1蓝色）
            });
        });

        confirmBtn.addEventListener('click', function() {
            const input = knowledgeInput.value.trim();
            console.log('[用户交互-确认按钮] 输入内容：', input);

            if (!input) {
                showModal();
                return;
            }

            hasInputKnowledge = true;
            streamCozeRecommendation(input);
        });

        exploreLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                if (!hasInputKnowledge) {
                    e.preventDefault();
                    showModal();
                }
            });
        });

        modalClose.addEventListener('click', hideModal);
        tipModal.addEventListener('click', function(e) {
            if (e.target === tipModal) hideModal();
        });

        knowledgeInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') confirmBtn.click();
        });
    </script>
</body>
</html>