<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学伴智享空间 - 灵感搜题</title>
  <link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { color:#333; line-height:1.6; padding:20px; min-height:100vh; }
    .container { max-width:1000px; margin:0 auto; padding:20px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding:18px 22px; background:rgba(255,255,255,0.92); border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.1); }
    .logo { display:flex; align-items:center; gap:12px; }
    .logo-icon { font-size:28px; color:#3498db; }
    .logo-text { font-size:22px; font-weight:700; color:#2c3e50; }
    .card { background: rgba(255,255,255,0.95); border-radius:16px; padding:24px; box-shadow:0 8px 32px rgba(0,0,0,0.1); border-left:5px solid #3498db; margin-top:20px; }
    .title { font-size:20px; font-weight:700; color:#2c3e50; display:flex; align-items:center; gap:10px; margin-bottom:16px; }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:6px; }
    .form-item { display:flex; flex-direction:column; gap:8px; }
    label { color:#2c3e50; font-weight:600; }
    select, textarea { width:100%; padding:12px 14px; border-radius:10px; border:1px solid #e0e0e0; background:#fafbfc; outline:none; transition:border-color 0.2s,box-shadow 0.2s; color:#333; font-family: inherit; }
    select { appearance:none; -webkit-appearance:none; -moz-appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath fill='%23677' d='M5.5 7.5l4.5 5 4.5-5z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; padding-right:36px; cursor:pointer; }
    textarea { min-height:140px; resize:vertical; grid-column:1 / -1; }
    .actions { margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; }
    .btn { display:inline-flex; align-items:center; gap:8px; background: linear-gradient(to right, #6a11cb, #2575fc); color:#fff; border:none; padding:10px 18px; border-radius:10px; cursor:pointer; font-size:14px; transition:transform 0.2s, background-color 0.2s, box-shadow 0.2s; }
    .btn:hover { transform:translateY(-1px); box-shadow:0 8px 18px rgba(37,117,252,0.25); }
    .loading { display:none; margin-top:14px; color:#f39c12; font-weight:600; }
    .result-card { display:none; margin-top:20px; }
    .result-section { margin-top:8px; background:#f7f9fc; padding:14px; border-radius:10px; border:1px solid #eef2f6; }
    .result-section img { max-width:100%; margin-top:8px; border-radius:8px; }
    .muted { color:#7f8c8d; font-size:14px; }
    @media (max-width:700px){ .form-grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo"><i class="fas fa-search logo-icon"></i><div class="logo-text">灵感搜题</div></div>
    <div class="muted"><i class="fas fa-shield-alt"></i> 学伴智享空间</div>
  </header>

  <div class="card">
    <div class="title"><i class="fas fa-pen"></i><span>输入题目信息</span></div>
    <div class="form-grid">
      <div class="form-item">
        <label for="gradeLevel">学段</label>
        <select id="gradeLevel"><option value="初中" selected>初中</option></select>
      </div>
      <div class="form-item">
        <label for="knowledgePoint">知识点</label>
        <select id="knowledgePoint">
          <option value="函数">函数</option>
          <option value="方程">方程</option>
          <option value="不等式">不等式</option>
          <option value="几何">几何</option>
          <option value="概率">概率</option>
          <option value="统计">统计</option>
          <option value="数列">数列</option>
          <option value="集合">集合</option>
          <option value="代数">代数</option>
        </select>
      </div>
      <div class="form-item">
        <label for="subject">科目</label>
        <select id="subject">
          <option value="数学" selected>数学</option>
        </select>
      </div>
      <div class="form-item" style="grid-column:1 / -1;">
        <label for="question">题目</label>
        <textarea id="question" placeholder="请输入题目完整描述">回顾往期</textarea>
      </div>
    </div>
    <div class="actions">
      <button class="btn" onclick="callCozeAPI()"><i class="fas fa-paper-plane"></i> 提交问题</button>
    </div>
    <div id="loading-indicator" class="loading"><i class="fas fa-spinner fa-spin"></i> 正在分析中，请稍候…</div>
  </div>

  <div id="analysis-results" class="card result-card">
     <div class="title"><i class="fas fa-compass"></i><span>参考解法/推荐</span></div>
     <div id="recommendations" class="muted"></div>
     <div class="result-section">
       <h4><i class="fas fa-file-word"></i> 文档预览</h4>
       <div id="docx-preview" class="muted">如有 docx 将在此展示</div>
     </div>
  </div>
</div>

<script>
async function callCozeAPI(){
  const WORKFLOW_ID="7544937264335339563";
  const APP_ID="7544826727500627968";
  const PAT="pat_Z6Rslhq4RGEvDyxSGcRjxIhk2aCsXVerWCHrHpqd95qhQXG42lnzb3L8t3tVFLjl";

  const loadingEl=document.getElementById('loading-indicator');
  const resultEl=document.getElementById('analysis-results');
  const recommendationsEl=document.getElementById('recommendations');

  loadingEl.style.display='block';
  resultEl.style.display='none';
  recommendationsEl.textContent='处理中…';

  const formData={
    grade: document.getElementById('gradeLevel').value,
    subject: document.getElementById('subject').value,
    knowledge_point: document.getElementById('knowledgePoint').value,
    question: document.getElementById('question').value
  };

  
  const cozeInputs={
    _input: {
      CONVERSATION_NAME: "",
      USER_INPUT: "回顾题目",
      grade: "eq.七上",
      student_id: "eq.20250001",
      student_name: "eq.张三"
    },
    
    ...formData
  };

  const requestData={
    workflow_id:WORKFLOW_ID,
    app_id:APP_ID,
    inputs:cozeInputs,
    parameters:{ user_id:"student_"+Date.now(), query_time:new Date().toISOString() }
  };

  try{
    const response=await fetch("https://api.coze.cn/v1/workflow/stream_run",{
      method:"POST",
      headers:{ "Authorization":`Bearer ${PAT}`,"Content-Type":"application/json" },
      body:JSON.stringify(requestData)
    });
    if(!response.ok) throw new Error(`API错误：状态码${response.status}`);

    const reader=response.body.getReader();
    const decoder=new TextDecoder();
    let doneContent='';

    while(true){
      const {done,value}=await reader.read();
      if(done) break;
      let chunk=decoder.decode(value,{stream:true});
      const lines=chunk.split("\n");
      for(const line of lines){
        if(line.startsWith("data:")){
          try{ const obj=JSON.parse(line.substring(5).trim()); if(obj.content) doneContent=obj.content; }catch(e){}
        }
      }
    }

     if(doneContent){
      try{
         const parsedContent=JSON.parse(doneContent.replace(/\\"/g,'"').replace(/\\\\/g,'\\'));
         recommendationsEl.innerHTML=parsedContent.output3 || parsedContent.output4 || "暂无结果";

         // 图片
        if(parsedContent.output4){
          const urls=parsedContent.output4.split(',');
          urls.forEach(url=>{
            const img=document.createElement('img');
            img.src=url;
            recommendationsEl.appendChild(img);
          });
        }

         // 解析并预览 docx
         const previewEl=document.getElementById('docx-preview');
         const docMatch=(parsedContent.output3||'').match(/https?:\/\/\S+\.docx/);
         if(docMatch){
           const docUrl=docMatch[0];
           previewEl.textContent='文档加载中…';
           fetch(docUrl).then(r=>r.arrayBuffer()).then(arrayBuffer=>
             window.mammoth.convertToHtml({arrayBuffer}).then(result=>{
               previewEl.innerHTML=result.value;
               const download=document.createElement('a');
               download.href=docUrl;
               download.textContent='下载整理好的文档';
               download.target='_blank';
               previewEl.appendChild(document.createElement('hr'));
               previewEl.appendChild(download);
             })
           ).catch(()=>{
             previewEl.innerHTML='预览失败，请使用下方链接下载查看： ';
             const a=document.createElement('a');
             a.href=docUrl; a.textContent='下载整理好的文档'; a.target='_blank';
             previewEl.appendChild(a);
           });
         }

        loadingEl.style.display='none';
        resultEl.style.display='block';
      }catch(err){
        console.error(err);
        recommendationsEl.textContent='解析失败，请稍后重试。';
        loadingEl.style.display='none';
        resultEl.style.display='block';
      }
    } else {
      recommendationsEl.textContent='未获得结果，请重试。';
      loadingEl.style.display='none';
      resultEl.style.display='block';
    }
  }catch(error){
    console.error(error);
    recommendationsEl.textContent='请求失败：'+(error.message||'未知错误');
    loadingEl.style.display='none';
    resultEl.style.display='block';
  }
}
</script>
</body>
</html>
